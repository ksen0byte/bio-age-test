<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BioAge Test</title>
    <link rel="stylesheet" href="style.css">

    <script type="module">
        import reactionApp from './app.js';

        document.addEventListener('alpine:init', () => {
            Alpine.data('reactionApp', reactionApp);
        });
    </script>

    <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
</head>
<body x-data="reactionApp" @keydown.window.escape="quitTest">

<div class="app-container">

    <section x-show="screen === 'login'">
        <h1>–í–∏–∑–Ω–∞—á–µ–Ω–Ω—è –±—ñ–æ–ª–æ–≥—ñ—á–Ω–æ–≥–æ –≤—ñ–∫—É</h1>
        <form @submit.prevent="login">
            <div class="form-group">
                <label>–ü–Ü–ë</label>
                <input type="text" x-model="user.name" required placeholder="–Ü–≤–∞–Ω–µ–Ω–∫–æ –Ü–≤–∞–Ω">
            </div>
            <div class="form-group">
                <label>–í—ñ–∫ (7-16)</label>
                <input type="number" x-model="user.age" required min="7" max="16">
            </div>
            <div class="form-group">
                <label>–°—Ç–∞—Ç—å</label>
                <select x-model="user.gender">
                    <option value="male">–ß–æ–ª–æ–≤—ñ—á–∞</option>
                    <option value="female">–ñ—ñ–Ω–æ—á–∞</option>
                </select>
            </div>
            <div class="form-actions">
                <button type="submit" class="btn">‚ùØ‚ùØ‚ùØ‚ùØ –ü–æ—á–∞—Ç–∏</button>
                <button type="button" @click="showHistory" class="btn btn-secondary">üìú –Ü—Å—Ç–æ—Ä—ñ—è</button>
            </div>
        </form>
    </section>

    <section x-show="screen === 'instruction'">
        <h2 x-text="`–°–µ—Ä—ñ—è ${round} –∑ ${totalRounds}`"></h2>
        <div class="instruction-box">
            <p>–ù–∞ –µ–∫—Ä–∞–Ω—ñ –∑'—è–≤–ª—è—Ç–∏–º—É—Ç—å—Å—è —á–µ—Ä–≤–æ–Ω—ñ –∫–≤–∞–¥—Ä–∞—Ç–∏.</p>
            <p>–¢–∏—Å–Ω—ñ—Ç—å <strong>–ü–†–û–ë–Ü–õ</strong> —è–∫–Ω–∞–π—à–≤–∏–¥—à–µ.</p>
        </div>
        <button @click="startRound" class="btn">–ì–æ—Ç–æ–≤–∏–π!</button>
    </section>

    <section x-show="screen === 'test'"
             class="full-screen-dark"
             @touchstart.prevent="handleInput"
             @keydown.window.space="handleInput">

        <div id="stimulus-area">
            <div x-show="isStimulusVisible" class="shape"></div>
        </div>

        <div x-show="debug" class="test-info">
            –°—Ç–∏–º—É–ª: <span x-text="`${stimulusIndex} / ${totalStimuli}`"></span>
        </div>
    </section>

    <section x-show="screen === 'spam-error'" class="screen active">
        <h2 style="color: #dc2626;">–ü–æ–º–∏–ª–∫–∞!</h2>
        <div class="instruction-box">
            <p>–í–∏ –Ω–∞—Ç–∏—Å–∫–∞—î—Ç–µ –∑–∞–Ω–∞–¥—Ç–æ —á–∞—Å—Ç–æ –∞–±–æ –±–µ–∑ –∫–æ–º–∞–Ω–¥–∏.</p>
            <p>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ —Ü—ñ—î—ó —Å–µ—Ä—ñ—ó –∞–Ω—É–ª—å–æ–≤–∞–Ω–æ.</p>
            <p>–ë—É–¥—å –ª–∞—Å–∫–∞, –±—É–¥—å—Ç–µ —É–≤–∞–∂–Ω—ñ—à—ñ.</p>
        </div>
        <button @click="retryRound" class="btn btn-warning">–ü–µ—Ä–µ–ø—Ä–æ–π—Ç–∏ —Å–µ—Ä—ñ—é</button>
    </section>

    <section x-show="screen === 'break'">
        <h2>–ü–µ—Ä–µ—Ä–≤–∞</h2>
        <p>–í—ñ–¥–ø–æ—á–∏–Ω—å—Ç–µ –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–µ—Ä—ñ—î—é.</p>
        <div class="timer-display" x-text="timerDisplay"></div>
        <button @click="skipBreak" x-show="debug" class="btn btn-small">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏</button>
    </section>

    <section x-show="screen === 'result'">
        <h2>–†–µ–∑—É–ª—å—Ç–∞—Ç–∏</h2>
        <template x-if="results && bioAge">
            <div class="result-box">
                <div class="result-row"><span>–£—á–∞—Å–Ω–∏–∫:</span> <strong x-text="user.name"></strong></div>
                <div class="result-row">
                    <span>–í—ñ–∫ / –°—Ç–∞—Ç—å:</span>
                    <span x-text="`${user.age} / ${user.gender === 'male' ? '–ß–æ–ª' : '–ñ—ñ–Ω'}`"></span>
                </div>
                <hr class="my-2">

                <template x-for="(avg, i) in results.roundAverages">
                    <div class="result-row">
                        <span x-text="`–°–µ—Ä—ñ—è ${i + 1}:`"></span>
                        <span x-text="`${Math.round(avg)} –º—Å`"></span>
                    </div>
                </template>

                <div class="result-row highlight mt-2">
                    <span>–°–µ—Ä–µ–¥–Ω—î:</span>
                    <span x-text="`${results.grandAverage} –º—Å`"></span>
                </div>

                <hr class="my-2">

                <div class="result-row">
                    <span>–ù–æ—Ä–º–∞:</span>
                    <span x-text="`${bioAge.normMs} –º—Å`"></span>
                </div>
                <div class="result-row highlight mt-2">
                    <span>–ë—ñ–æ–ª–æ–≥—ñ—á–Ω–∏–π –≤—ñ–∫:</span>
                    <span x-text="`${bioAge.biologicalAge} —Ä–æ–∫—ñ–≤`"></span>
                </div>
            </div>
        </template>

        <button @click="restart" class="btn">–ù–æ–≤–∏–π —É—á–∞—Å–Ω–∏–∫</button>
    </section>

    <section x-show="screen === 'history'" class="screen active">
        <h2>–Ü—Å—Ç–æ—Ä—ñ—è —Ç–µ—Å—Ç—É–≤–∞–Ω—å</h2>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                <tr style="background: #eee; text-align: center;">
                    <th style="padding: 8px;">–î–∞—Ç–∞</th>
                    <th style="padding: 8px;">–Ü–º'—è</th>
                    <th style="padding: 8px;">–í—ñ–∫</th>
                    <th style="padding: 8px;">–°—Ç–∞—Ç—å</th>
                    <th style="padding: 8px;">–°–µ—Ä–µ–¥–Ω—ñ–π –ß–∞—Å –†–µ–∞–∫—Ü—ñ—ó (–º—Å)</th>
                    <th style="padding: 8px;">–ë—ñ–æ–ª–æ–≥—ñ—á–Ω–∏–π –í—ñ–∫</th>
                    <th style="padding: 8px;">–î—ñ—ó</th>
                </tr>
                </thead>
                <tbody>
                <template x-for="rec in history" :key="rec.id">
                    <tr style="border-bottom: 1px solid #ddd;">
                        <td style="padding: 8px;" x-text="new Date(rec.date).toLocaleString()"></td>
                        <td style="padding: 8px;" x-text="rec.user.name"></td>
                        <td style="padding: 8px;" x-text="rec.user.age"></td>
                        <td style="padding: 8px;" x-text="rec.user.gender === 'male' ? '–ß' : '–ñ'"></td>
                        <td style="padding: 8px;" x-text="rec.results.grandAverage"></td>
                        <td style="padding: 8px;" x-text="rec.bioAge ? rec.bioAge.biologicalAge : '-'"></td>
                        <td style="padding: 8px;">
                            <button @click="deleteRecord(rec.id)" style="color: red; border: none; background: none; cursor: pointer;">–í–∏–¥–∞–ª–∏—Ç–∏ ‚úï</button>
                        </td>
                    </tr>
                </template>
                </tbody>
            </table>
        </div>

        <p x-show="history.length === 0" style="text-align: center; color: #888;">–Ü—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è</p>

        <button @click="goHome" class="btn">‚Üê –ù–∞–∑–∞–¥</button>
    </section>

</div>
</body>
</html>